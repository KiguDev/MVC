@using RestauranteBLL
@using RestauranteEntity
@using Humanizer
@{
    Page.Title = "Nueva empleado";
    Layout = "~/_SiteLayout.cshtml";
    var mensaje = "";
    var clientes = ClienteBL.ObtenerTodos();
    var id = Request.QueryString["id"].AsInt();
    var resid = Request.QueryString["resid"].AsInt();
    var reservacion = new Reservacion();
    if (resid == 0)
    {
        Response.Redirect("~/");
    }
    var restaurant = RestauranteBL.ConsultarRestaurante(resid);
    if (IsPost && Validation.IsValid())
    {
        //Solo entra cuando es post
        var clienteId = Request.Form["ClienteId"].AsInt();
        var mesaId = Request.Form["MesaId"].AsInt();
        var fechainicio = Request.Form["FechaInicio"].AsDateTime();
        var fechaFin = Request.Form["FechaFin"].AsDateTime();

        reservacion.ClienteId = clienteId;
        reservacion.Mesaid = mesaId;
        reservacion.FechaInicio = fechainicio;
        reservacion.FechaFin = fechaFin;
        reservacion.Id = id;
        reservacion.Estado =(int) EstadoReservacion.Pendiente;
        
        if (!ReservacionBL.Disponible(0, mesaId, fechainicio, fechaFin))
        {
            mensaje = "La fecha solicitada no esta disponible";
        }
        else
        {
            if (id > 0)
            {
                RestauranteBLL.ReservacionBL.Editar(reservacion);
            }
            else
            {
                if (RestauranteBLL.ReservacionBL.Insertar(reservacion) < 0)
                {
                    //Manejo de excepciones
                }
            }
            Response.Redirect("~/Restaurant/reservacion/?resid=" + resid);
        }
    }
    else
    {
        if (id > 0)
        {
            reservacion = ReservacionBL.Obtener(id);
        }
    }


}
@section Scripts{
    <script>
        $(document).ready(function () {

            $("#ClienteId").select2();
            $("#MesaId").select2();  
            $("#FechaInicio").val("@reservacion.FechaInicio");
            $("#FechaFin").val("@reservacion.FechaFin");
        })

    </script>

}
@if (!String.IsNullOrEmpty(mensaje))
{
    <label class="text-danger">@mensaje</label>
}
<form method="post">
    @Html.ValidationSummary()
    <div class="form-group">
        <label>Cliente</label>
        <select name="ClienteId" id="ClienteId" class="select2 form-control">
            @foreach (var cte in clientes.OrderBy(c => c.Nombre))
            {
                <option @if (reservacion.ClienteId == cte.Id) {<text>selected</text> } value="@cte.Id">@cte.Nombre</option>
            }
        </select>
    </div>
    <div class="form-group">
        <label>Mesa</label>
        <select name="MesaId" id="MesaId" class="select2 form-control">
            @foreach (var mesa in restaurant.Mesa.OrderBy(c => c.Identificador))
            {
                <option @if (reservacion.Mesaid == mesa.Id) {<text>selected</text> } value="@mesa.Id">@mesa.Identificador</option>
            }
        </select>
    </div>
    <div class="form-group">
        <label>Desde</label>
        <input type="datetime-local" class="form-control " name="FechaInicio" @if (reservacion.FechaInicio.Year != 1) {<text> value="@reservacion.FechaInicio.ToString("yyyy-MM-ddTHH:mm:ss") </text>} "  />
    </div>
    <div class="form-group">
        <label>Hasta</label>
        <input type="datetime-local" class="form-control  " name="FechaFin"  @if (reservacion.FechaInicio.Year != 1) {<text>value="@reservacion.FechaFin.ToString("yyyy-MM-ddTHH:mm:ss")</text>} "  />
    </div>
    <button type="submit" class="btn btn-light" >GUARDAR</button>
</form>

