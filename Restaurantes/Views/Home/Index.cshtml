@model List<Restaurante>


<h1>
    Restaurantes
</h1>
<a onclick="MostrarAgregar()" class="btn btn-outline-primary">Agregar</a>
<a class="btn btn-primary" asp-action="Agregar">Agregar Restaurante</a>
@*<a class="btn btn-primary" asp-controller="Empleado" asp-action="Empleados">Ir a empleados</a>*@
<table class="table table-bordered" id="tabla-restaurantes-contenido">
    <thead>
        <tr>
            <th>Id</th>
            <th>Nombre</th>
            <th>Domicilio</th>
            <th>Telefono</th>
            <th>Mesas</th>
            <th>Empleados</th>
            <th></th>
            <th>Productos</th>
            <th>Ordenes</th>
        
        </tr>
    </thead>
    <tbody >
        @*@foreach (var restaurante in Model)
        {
        <tr class="row-@restaurante.Id">
            <td>@restaurante.Id</td>
            <td>@restaurante.Nombre</td>
            <td>@restaurante.Domicilio</td>
            <td>@restaurante.Telefono</td>
            <td><a href=""></a>@restaurante.Mesas.Count()</td>
            <td> <a asp-controller="Home" asp-action="Mesas" asp-route-id="@restaurante.Id">Ver mesas</a></td>
            <td><a asp-action="Editar" asp-route-id="@restaurante.Id">Editar</a></td>
            <td><a asp-controller="Empleado" asp-action="Empleados" asp-route-id="@restaurante.Id">Ver Empleados</a> </td>
            <td>
                <form asp-action="Eliminar">
                <button type="submit" name="Id" value="@restaurante.Id" class="btn btn-danger">Eliminar</button>
            </form>
                <a href="#" class="ejecutar-eliminacion" data-id="@restaurante.Id"> Eliminacion</a>
            </td>
        </tr>
        }*@
    </tbody>
</table>

<div class="modal" id="agregarModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" >
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Agregar</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modalCuerpo">
             
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="GuardarRestaurant()">Guardar</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editarModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Editar</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modalEditarCuerpo">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnEditarModal">Editar</button>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <script> 

        window.onload = function () {

            document.getElementById("btnEditarModal").addEventListener("click", function () {
                EditarRestaurant();
            })
        }
        function EditarRestaurant() {

            var Nombre = document.getElementById("Nombre").value;
            var Domicilio = document.getElementById("Domicilio").value;
            var Telefono = document.getElementById("Telefono").value;
            var Logo = document.getElementById("Logo").value;
            var PaginaWeb = document.getElementById("PaginaWeb").value;
            var HoraDeCierre = document.getElementById("HoraDeCierre").value;
            var Id = document.getElementById("Id").value;

            var fd = {};

            fd["Nombre"] = Nombre;
            fd["Domicilio"] = Domicilio;
            fd["Telefono"] = Telefono;
            fd["Logo"] = Logo;
            fd["PaginaWeb"] = PaginaWeb;
            fd["HoraDeCierre"] = HoraDeCierre;
            fd["Id"] = Id;


            fetch("/Api/Restaurantes/", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(fd)
            }).then(function (response) {
                if (response.ok) {
                    $("#editarModal").modal("hide");//JQUERY
                    table.ajax.reload(AddListeners);

                }
            });

        }

        function AddListeners() {
            //JAVASCRIPT NATIVO PARA AGREGAR EVENTOS
            var buttons = document.getElementsByClassName("editar-restaurant");
            for (i = 0; i < buttons.length; i++) {
                buttons[i].addEventListener("click", function () {
                    MostrarEditar(this.dataset.id)
                })
            }
        }

       function MostrarEditar(id) {

       fetch(`@Url.Action("Editar","Home")/${id}`, {
            method: "GET"
         }).then(function (response) {
            if (response.ok) {
                response.text().then(function (text) {
                    LimpiarModales()
                    document.getElementById("modalEditarCuerpo").innerHTML = text;
                    $("#editarModal").modal("show");//JQUERY

                })
            }
        });
    }

       function MostrarAgregar() {

       fetch("@Url.Action("Agregar","Home")", {
            method: "GET"
         }).then(function (response) {
            if (response.ok) {
                response.text().then(function (text) {
                    LimpiarModales()
                    document.getElementById("modalCuerpo").innerHTML = text;
                    $("#agregarModal").modal("show");//JQUERY

                })
            }
        });
        }


        function LimpiarModales() {

            var bodies = document.getElementsByClassName("modal-body");

            for (i = 0; i < bodies.length; i++) {
                bodies[i].innerHTML = ""
            }
        }

        function GuardarRestaurant() {
            var nombre = document.getElementById("Nombre").value;
            var domicilio = document.getElementById("Domicilio").value;
            var telefono = document.getElementById("Telefono").value;
            var logo = document.getElementById("Logo").value;
            var paginaWeb = document.getElementById("PaginaWeb").value;
            var HoraDeCierre = document.getElementById("HoraDeCierre").value;
            

            var fd = {};
            fd["Nombre"] = nombre;
            fd["Domicilio"] = domicilio;
            fd["Telefono"] = telefono;
            fd["Logo"] = logo;
            fd["PaginaWeb"] = paginaWeb;
            fd["HoraDeCierre"] = HoraDeCierre;

            fetch("/api/restaurantes/", {
                method: "POST",
                headers: {
                    'Content-Type':'application/json'
                },
                body: JSON.stringify(fd)
            }).then(function (response) {
            if (response.ok) {
                $("#agregarModal").modal("hide");
                table.ajax.reload(AddListeners);
            }

        });
            
        }
    </script>
    <script>
    
    @*$('#tabla-restaurantes').on('click','.ejecutar-eliminacion', function (event) {
        event.preventDefault();
        //var id = $(this).attr('data-id');
        var id = $(this).data('id');
       
        bootbox.confirm("Seguro que quieres eliminar este elemento?", function (IsConfirmed) {
            if (IsConfirmed) {
                // eliminar elemento
                $.ajax({
                    url: '/api/restaurantes/' + id,
                    type: 'DELETE',
                    success: recargarElementos
                });
            }
        });
    });
    function recargarElementos() {
        // obtener elementos
        $.getJSON('/api/restaurantes/', function (data) {
            var rows;
            data.forEach(function (element) {
                var row = '<tr>'
                + '<td class="clase">' + element.NombreRestaurante + '</td>'
                        + '<td>' + element.direccion + '</td>'
                        + '<td>' + element.telefono + '</td>'
                        + '<td><a href="@Url.Action("Mesas", "Index")/"' + element.id + '">' + element.cantidadMesas + '</a></td>'
                        + '<td><a href="@Url.Action("Editar")/"' + element.id + '">Editar</a> <a href="#" data-id="' + element.id + '" class="ejecutar-eliminacion">Eliminar</a></td>'
                        + '</tr>';
                rows += row;
            });
            $('#tabla-restaurantes').html(rows);
        });
        }*@
        var table;
        $(document).ready(function () {
            table = $('#tabla-restaurantes-contenido').DataTable({
                "initComplete": function () {
                    AddListeners();
                },
                ajax: {
                    url: '/api/restaurantes',
                    dataSrc: '',
                },
                columns: [
                    { data: 'id' },
                    {
                        data: 'nombre',
                        render: function (data, type, row) {
                            return '<a href="@Url.Action("Info")/' + row.id + '">' + data + '</a>'
                        },
                               
                    },
                    { data: 'domicilio' },
                    { data: 'telefono' },
                    {
                        data: 'mesas',
                        render: function (data, type, row) {
                            return '<a href="@Url.Action("Mesas")/' + row.id + '">' + data + '</a>'
                        },
                    },
                    {
                        data: 'empleados',
                        render: function (data, type, row) {
                            return '<a class="btn btn-outline-dark" href="@Url.Action("Empleados","Empleado")/' + row.id + '">Empleados</a>'
                        },
                    },
                    {
                        render: (data, type, row) => {
                        return `<a class="btn btn-info editar-restaurant" data-id="${row.id}">Editar</a>`
                        }
                    },
                    {
                        render: (data, type, row) => {
                            return '<a class="btn btn-outline-dark" href="@Url.Action("Productos","Producto")/' + row.id + '">Productos</a>'
                        }
                    },
                    {
                        render: (data, type, row) => {
                            return '<a class="btn btn-outline-dark" href="@Url.Action("Index","Ordenes")/' + row.id + '">Ordenes</a>'
                        }
                    }
                    
                    
                ],               
                select: true,
                dom : 'Bfrtip',
                buttons: [
                    'copy', 'excel', 'pdf', 
                    {
                        text: 'Eliminar',
                        action: function () {
                            var rows = table.rows({ selected: true }).data();
                            var ids = [];
                            for (var x = 0; x < rows.length; x++) {
                                ids.push(rows[x].id);
                            }
                        bootbox.confirm("¿Seguro que quieres eliminar Restaurante?", function (ConfirmedDelete) {
                            if (ConfirmedDelete) {
                                $.ajax({
                                    url: '/api/restaurantes/',
                                    data: '[' + ids.toString() + ']',
                                    contentType: 'application/json',
                                    type: 'DELETE',
                                    success: function () {
                                        table.ajax.reload();
                                    }
                                });
                            }
                        });

                            console.log(ids);
                        }
                    }
                    
                ]
            });
            
        });
    </script>
}


