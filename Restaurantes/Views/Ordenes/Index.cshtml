@model OrdenViewModel

<h1>Ordenes</h1>
<a class="btn btn-outline-primary" id="btnEnviar">Guardar</a>
<a class="btn btn-outline-secondary" href="@Url.Action("Ordenes", "Ordenes")/@Model.RestauranteId" id="VerOrdenes">Ver Ordenes</a>
<style>
    .column {
        float: left;
        width: 33.33%;
        height: 20px; 
    }

    
    .row:after {
        content: "";
        display: table;
        clear: both;
    }
</style>
<div class="row">
    <div class="col-sm-6" id="Productos">
        <table class="table">
            <tr>
                <th>Producto</th>
                <th>Id</th>
                <th>Precio</th>
            </tr>
            <tbody></tbody>
        </table>

    </div>
    <div class="col-sm-6" id="Totales">

    </div>
</div>
<div class="row">
    <div class="col-sm-6"></div>
    <div class="col-sm-6">
        <h3>TOTAL <b id="total-label">0</b> </h3>
    </div>
</div>
<div class="modal" tabindex="-1" role="dialog" id="modalCantidad">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cantidad</h5>

                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>

            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="cantidad-modal">Cantidad de producto</label>
                    <input type="number" class="form-control" id="cantidad-modal" min="0" />
                    <input type="hidden" id="precio-modal" />
                    <input type="hidden" id="id-modal" />
                    <input type="hidden" id="nombre-modal" />
                    <input type="hidden" id="total-modal"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="agregarProducto">Agregar</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script src="~/lib/jquery/dist/jquery.js"></script>

<script>


    var total = 0;
    var template;
    var templateRowProducto;
    var ordenId = 0;
    $("#btnEnviar").click(function () {
        if (ordenId == 0) {
            $.post("/api/ordenes/", { id: "@Model.RestauranteId" }, function (id) {
                ordenId = id;
                AgregarProductos();
            })
        }
        //var orden = {}
        //orden.id = ordenId;
        //orden.RestaurantId = @Model.RestauranteId;
        //var productos = [];

       

    })
    function AgregarProductos() {
        var productoId = $(templateRowProducto).find('.id-producto-orden').val();
        var rows = $(".row-producto-final")
        $.map(rows, function (prod) {
            var pNuevo = {};
            pNuevo.cantidad = $(prod).find('.cantidad-input').val();
            pNuevo.id = $(prod).find('.id-producto').val();
            pNuevo.ordenId = ordenId;
            pNuevo.productoId = productoId;
            $.post("/api/ordenes/GuardarOrdenProducto", pNuevo, function () {
                
            })
            //productos.push(pNuevo);

        })
    }

        
        


    //})

   
    

    $(document).ready(function () {

        //Obtiene el template del div de producto en TEXTO

        $.get('@Url.Action("ProductoView", "Ordenes")', function (res) {
            template = res;
        })
         $.get("@Url.Action("ProductoAddView", "Ordenes")", function (res) {
            templateRowProducto = res;
        })

        $.getJSON("/api/productos", {id:'@Model.RestauranteId'}, function (res) {
            $.map(res, function (r, val) {
                var element = $(template);
                element.find('.product-name').text(r.nombre);
                element.find('.id-producto').text(r.id);
                element.find('.precio-producto').text(r.precio);
                $("#Productos").append(element);
            })
        })

    })

    $(document).on('click', '.producto', function () {

        var id = $(this).find('.id-producto').text();
        var precio = $(this).find('.precio-producto').text();
        var nombre = $(this).find('.product-name').text();
        
        $("#id-modal").val(id);
        $("#precio-modal").val(precio);
        $("#nombre-modal").val(nombre);
        $("#modalCantidad").modal("show");
    })

    $("#agregarProducto").click(function () {
        var nombre = $("#nombre-modal").val();
        var id = $("#id-modal").val();
        var precio = $("#precio-modal").val();
        var cantidad = $("#cantidad-modal").val();

        
        var element = $(templateRowProducto);
        element.find('.producto-label').text(nombre);
        element.find('.cantidad-input').val(cantidad);
        element.find('.precio-label').text(precio);
        element.find('.id-producto-orden').val(id);
        $("#Totales").append(element);
        total += precio * cantidad
        $("#total-label").text(total);
        $("#modalCantidad").modal("hide");

    })

    $(document).on('click', '.elim', function () {
        var row = this;
        var cantidad = $("#cantidad-modal").val();  
        eliminarproductofila(row, cantidad);
       
    })


    function eliminarproductofila(row, cantidad) {
        
        var sub = $(row.parentNode.parentNode).find(".precio-label").text();

        total -= sub * cantidad;
        $("#total-label").text(total);


        $(row.parentNode.parentNode).animate({
            left: '250px',
            opacity: '0.3',
            height: '100px',
            width: '0px',

        });

        setTimeout(function () {
            row.parentNode.parentNode.parentNode.removeChild(row.parentNode.parentNode);
        }, 300);
    }
    



</script>

